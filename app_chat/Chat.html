{% extends "global/Page.html" %}
{% block title %}Chat Window{% endblock %}

{% block content %}
<style>
  .chat-wrap { max-width: 900px; margin: 0 auto; }
  .timer { font-size: 1.1rem; font-weight: 700; margin-bottom: 10px; }
  .info-bar { font-size: 0.9rem; color: #666; margin-bottom: 15px; }
  .chat-box { 
    border: 1px solid #ddd; 
    border-radius: 8px; 
    padding: 15px; 
    height: 400px; 
    overflow-y: auto; 
    background: #fff; 
    display: flex;
    flex-direction: column;
  }
  .chat-row { margin: 8px 0; display: flex; }
  .me { justify-content: flex-end; }
  .partner { justify-content: flex-start; }
  
  .bubble { 
    padding: 10px 14px; 
    border-radius: 12px; 
    max-width: 75%; 
    word-wrap: break-word;
    font-size: 1rem;
    line-height: 1.4;
  }
  .bubble-me { background: #007bff; color: white; border-bottom-right-radius: 2px; }
  .bubble-partner { background: #f1f0f0; color: #333; border-bottom-left-radius: 2px; }
  
  .starter-box { 
    background: #e9ecef; 
    padding: 12px; 
    border-radius: 8px; 
    margin-bottom: 15px; 
    font-style: italic;
    color: #495057;
    text-align: center;
    border: 1px dashed #ced4da;
  }

  .error-msg { 
    color: #dc3545; 
    font-weight: 600; 
    display: none; 
    margin-top: 8px; 
    font-size: 0.9rem;
  }
  
  .input-area { margin-top: 15px; }
</style>

<div class="chat-wrap">
  <div class="d-flex justify-content-between align-items-end mb-2">
    <div class="timer">Time left: <span id="timeLeft">10:00</span></div>
    <div class="info-bar">Condition: {{ condition }} | Role: {{ role }}</div>
  </div>

  <div class="starter-box">
    {{ starter_text }}
  </div>

  <div id="chatBox" class="chat-box" aria-live="polite">
    </div>

  <div id="errorMsg" class="error-msg">
    Message blocked: Please avoid sharing personal contact information or using inappropriate language.
  </div>

  <div class="input-group input-area">
    <input id="msgInput" type="text" class="form-control" placeholder="Type your message here..." autocomplete="off" />
    <div class="input-group-append">
      <button id="sendBtn" type="button" class="btn btn-primary">Send</button>
    </div>
  </div>

  <input type="hidden" name="chat_log" id="id_chat_log">
</div>

<script>
  // Pass initial AI message from template to JavaScript
  window.initial_ai_message = {{ initial_ai_message_json|safe }};
</script>

<script>
(function () {
  // --- 1. 初始化变量 ---
  const chatSeconds = js_vars.chatSeconds || 600;
  const condition = (js_vars.condition || "").trim();
  
  // 敏感词库 (示例 - 实际应用建议扩充)
  const badWords = ["fuck", "shit", "bitch", "asshole", "cunt", "stupid", "idiot"];

  // --- 2. 验证逻辑 ---
  function looksLikeEmail(text) {
    // 匹配 xxxx@xxxx.xx
    return /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/.test(text);
  }

  function looksLikePhone(text) {
    // 匹配 10位以上数字，或常规电话格式 xxx-xxx-xxxx
    // 排除简单的年份或是数字提及，要求比较严格的格式
    const phoneRegex = /(\d{3}[-\.\s]??\d{3}[-\.\s]??\d{4})|(\b\d{10,}\b)/;
    return phoneRegex.test(text);
  }

  function containsProfanity(text) {
    const lower = text.toLowerCase();
    // 简单匹配单词边界，防止匹配到 substring (e.g. Scunthorpe)
    return badWords.some(w => {
       const regex = new RegExp(`\\b${w}\\b`, 'i');
       return regex.test(lower);
    });
  }

  function isBlocked(text) {
    if (!text) return true;
    if (looksLikeEmail(text)) return true;
    if (looksLikePhone(text)) return true;
    if (containsProfanity(text)) return true;
    return false;
  }

  // --- 3. DOM 元素 ---
  const chatBox = document.getElementById('chatBox');
  const msgInput = document.getElementById('msgInput');
  const sendBtn = document.getElementById('sendBtn');
  const errorMsg = document.getElementById('errorMsg');
  
  // --- 4. 核心功能：显示消息 ---
  function appendMessage(who, text) {
    const row = document.createElement('div');
    row.className = 'chat-row ' + (who === 'me' ? 'me' : 'partner');

    const bubble = document.createElement('div');
    bubble.className = 'bubble ' + (who === 'me' ? 'bubble-me' : 'bubble-partner');
    bubble.innerText = text; // 使用 innerText 防止 XSS

    row.appendChild(bubble);
    chatBox.appendChild(row);
    
    // 自动滚动到底部
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  // --- 5. 与后端通信 (LiveSocket) ---
  // oTree 自动注入 liveRecv 函数来接收后端消息
  window.liveRecv = function(data) {
    console.log("DEBUG: liveRecv received:", data);
    
    // 能够处理对象或对象数组
    if (Array.isArray(data)) {
        data.forEach(function(item) {
            if (item.type === 'new_message') {
                appendMessage(item.sender, item.text);
            }
        });
    } else {
        if (data.type === 'new_message') {
            appendMessage(data.sender, data.text);
        }
    }
  };

  // --- 6. 发送处理 ---
  function trySend() {
    console.log("DEBUG: trySend called");
    const text = (msgInput.value || "").trim();
    
    if (text === "") return;

    // 检查违规内容 (客户端实时反馈)
    if (isBlocked(text)) {
      console.log("DEBUG: Message blocked");
      errorMsg.style.display = 'block';
      // 3秒后隐藏错误提示
      setTimeout(() => { errorMsg.style.display = 'none'; }, 3000);
      return;
    }
    
    // 验证通过，发送给后端
    errorMsg.style.display = 'none';
    msgInput.value = "";
    
    console.log("DEBUG: Sending via liveSend:", text);
    // 调用 oTree 的 liveSend
    liveSend({ 'text': text });
  }

  // --- 7. 事件监听 ---
  sendBtn.addEventListener('click', trySend);
  
  msgInput.addEventListener('keydown', function (e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      trySend();
    }
  });

  // --- 8. 页面加载：如果有初始 AI 消息（Group 4），显示它 ---
  if (window.initial_ai_message && window.initial_ai_message.text) {
    appendMessage('partner', window.initial_ai_message.text);
  }

  // --- 9. 倒计时器（持久化，刷新页面后继续计时） ---
  const timeLeftEl = document.getElementById('timeLeft');
  
  // 从 sessionStorage 获取开始时间；如果没有则现在开始
  let startTime = sessionStorage.getItem('chat_start_time');
  if (!startTime) {
    startTime = Date.now();
    sessionStorage.setItem('chat_start_time', startTime);
  }
  startTime = parseInt(startTime);

  function pad(n) { return n < 10 ? '0' + n : n; }

  const timerInterval = setInterval(() => {
    const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
    const timeRemaining = Math.max(0, chatSeconds - elapsedSeconds);
    
    if (timeRemaining <= 0) {
      clearInterval(timerInterval);
      timeLeftEl.textContent = "00:00";
      // 时间到，禁止输入
      msgInput.disabled = true;
      sendBtn.disabled = true;
      // 清除 sessionStorage
      sessionStorage.removeItem('chat_start_time');
      
      // 填充 chat_log 字段以完成表单验证
      const chatLogInput = document.getElementById('id_chat_log');
      if (chatLogInput) {
        // 确保chat_log字段有内容，即使为空也要设为占位符
        if (!chatLogInput.value) {
          chatLogInput.value = "Chat completed";
        }
      }
      
      // 延迟提交以确保DOM更新完成
      setTimeout(function() {
        console.log("Timer reached 0, starting form submission process");
        
        // 方法1：尝试找到oTree的Next按钮并点击
        const nextBtn = document.querySelector('button[type="submit"]');
        if (nextBtn) {
          console.log("Found and clicking submit button");
          nextBtn.click();
          console.log("Submit button clicked");
        } else {
          console.log("No submit button found, trying to find form");
          // 方法2：直接提交form
          const form = document.querySelector('form');
          if (form) {
            console.log("Found form, attempting to submit");
            console.log("Form has " + form.elements.length + " elements");
            
            // 确保所有必要的字段都已填充
            for (let i = 0; i < form.elements.length; i++) {
              if (form.elements[i].name === 'chat_log') {
                console.log("chat_log field value: " + form.elements[i].value);
              }
            }
            
            // 直接提交
            form.submit();
            console.log("Form.submit() called");
          } else {
            console.error("Could not find form");
          }
        }
      }, 100);
    } else {
      const m = Math.floor(timeRemaining / 60);
      const s = timeRemaining % 60;
      timeLeftEl.textContent = `${pad(m)}:${pad(s)}`;
    }
  }, 1000);

})();
</script>
{% endblock %}